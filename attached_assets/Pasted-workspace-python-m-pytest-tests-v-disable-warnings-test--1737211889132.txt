workspace$ python -m pytest tests/ -v --disable-warnings
==================================== test session starts ====================================
platform linux -- Python 3.11.10, pytest-8.1.1, pluggy-1.4.0 -- /home/runner/workspace/.pythonlibs/bin/python
cachedir: .pytest_cache
rootdir: /home/runner/workspace/tests
configfile: pytest.ini
plugins: asyncio-0.23.6, mock-3.14.0, cov-4.1.0, web3-6.11.3
asyncio: mode=Mode.AUTO
collected 75 items                                                                          

tests/functional/test_api.py::test_transformation_endpoint ERROR                      [  1%]
tests/functional/test_api.py::test_account_balance ERROR                              [  2%]
tests/functional/test_api.py::test_invalid_transformation ERROR                       [  4%]
tests/integration/test_auth_flow.py::test_complete_auth_flow ERROR                    [  5%]
tests/integration/test_auth_flow.py::test_complete_auth_flow ERROR                    [  5%]
tests/integration/test_auth_flow.py::test_auth_with_invalid_2fa ERROR                 [  6%]
tests/integration/test_auth_flow.py::test_auth_with_invalid_2fa ERROR                 [  6%]
tests/integration/test_auth_flow.py::test_kyc_submission_validation ERROR             [  8%]
tests/integration/test_auth_flow.py::test_kyc_submission_validation ERROR             [  8%]
tests/integration/test_blockchain.py::test_batch_transformation_process SKIPPED (...) [  9%]
tests/integration/test_blockchain.py::test_noble_rank_update SKIPPED (Blockchain ...) [ 10%]
tests/integration/test_blockchain.py::test_blockchain_stats PASSED                    [ 12%]
tests/integration/test_blockchain_transactions.py::test_gold_transformation SKIPPED   [ 13%]
tests/integration/test_blockchain_transactions.py::test_bonus_distribution SKIPPED    [ 14%]
tests/performance/test_load.py::test_concurrent_transformations FAILED                [ 16%]
tests/performance/test_load.py::test_blockchain_batch_performance FAILED              [ 17%]
tests/performance/test_load.py::test_system_under_heavy_load FAILED                   [ 18%]
tests/performance/test_load.py::test_performance_monitoring FAILED                    [ 20%]
tests/performance/test_monitoring.py::test_system_monitoring PASSED                   [ 21%]
tests/performance/test_monitoring.py::test_performance_monitor FAILED                 [ 22%]
tests/performance/test_monitoring.py::test_performance_decorator PASSED               [ 24%]
tests/performance/test_optimization.py::test_table_creation_and_optimization FAILED   [ 25%]
tests/security/test_security.py::test_environment_variables PASSED                    [ 26%]
tests/security/test_security.py::test_rate_limiter PASSED                             [ 28%]
tests/security/test_security.py::test_security_manager_logging PASSED                 [ 29%]
tests/security/test_security.py::test_permission_checking PASSED                      [ 30%]
tests/security/test_security.py::test_role_permission_validation PASSED               [ 32%]
tests/security/test_security.py::test_input_validation PASSED                         [ 33%]
tests/security/test_security.py::test_sql_injection_prevention PASSED                 [ 34%]
tests/security/test_security.py::test_xss_prevention PASSED                           [ 36%]
tests/security/test_security.py::test_rate_limiter_stress PASSED                      [ 37%]
tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_create_snapshot FAILED [ 38%]
tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_create_snapshot ERROR [ 38%]
tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_restore_snapshot FAILED [ 40%]
tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_restore_snapshot ERROR [ 40%]
tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_verify_snapshot_integrity FAILED [ 41%]
tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_verify_snapshot_integrity ERROR [ 41%]
tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_snapshot_not_found PASSED [ 42%]
tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_snapshot_not_found ERROR [ 42%]
tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_validate_fixing_price PASSED [ 44%]
tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_validate_fixing_price ERROR [ 44%]
tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_validate_system_status PASSED [ 45%]
tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_validate_system_status ERROR [ 45%]
tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_check_database_integrity PASSED [ 46%]
tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_check_database_integrity ERROR [ 46%]
tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_validate_distribution_result PASSED [ 48%]
tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_validate_distribution_result ERROR [ 48%]
tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_complete_distribution_flow_with_noble_ranks ERROR [ 49%]
tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_multi_level_affiliate_distribution ERROR [ 50%]
tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_distribution_validation[fixing_price0-balance0-Invalid fixing price] ERROR [ 52%]
tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_distribution_validation[fixing_price1-balance1-Invalid fixing price] ERROR [ 53%]
tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_distribution_validation[fixing_price2-balance2-Invalid balance] ERROR [ 54%]
tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_performance_under_load ERROR [ 56%]
tests/unit/test_blockchain_monitor.py::test_basic_monitoring FAILED                   [ 57%]
tests/unit/test_blockchain_monitor.py::test_transaction_validation FAILED             [ 58%]
tests/unit/test_blockchain_monitor.py::test_network_interruption ERROR                [ 60%]
tests/unit/test_blockchain_monitor.py::test_invalid_transaction ERROR                 [ 61%]
tests/unit/test_blockchain_monitor.py::test_concurrent_transactions FAILED            [ 62%]
tests/unit/test_blockchain_monitor.py::test_empty_block ERROR                         [ 64%]
tests/unit/test_blockchain_monitor.py::test_malformed_transaction ERROR               [ 65%]
tests/unit/test_blockchain_monitor.py::test_extreme_gas_prices FAILED                 [ 66%]
tests/unit/test_blockchain_monitor.py::test_network_timeout ERROR                     [ 68%]
tests/unit/test_blockchain_monitor.py::test_monitor_transaction FAILED                [ 69%]
tests/unit/test_blockchain_monitor.py::test_alert_system FAILED                       [ 70%]
tests/unit/test_blockchain_monitor.py::test_block_monitoring FAILED                   [ 72%]
tests/unit/test_blockchain_service.py::test_batch_transformation_process SKIPPED      [ 73%]
tests/unit/test_bonus_service.py::TestBonusDistributionService::test_distribute_structure_bonus ERROR [ 74%]
tests/unit/test_bonus_service.py::TestBonusDistributionService::test_distribute_rewards_successful ERROR [ 76%]
tests/unit/test_bonus_service.py::TestBonusDistributionService::test_distribute_rewards_invalid_rank ERROR [ 77%]
tests/unit/test_bonus_service.py::TestBonusDistributionService::test_distribute_rewards_insufficient_balance ERROR [ 78%]
tests/unit/test_constants.py::test_status_constants PASSED                            [ 80%]
tests/unit/test_imports.py::test_imports PASSED                                       [ 81%]
tests/unit/test_kyc_service.py::test_submit_kyc ERROR                                 [ 82%]
tests/unit/test_kyc_service.py::test_submit_kyc ERROR                                 [ 82%]
tests/unit/test_kyc_service.py::test_verify_kyc ERROR                                 [ 84%]
tests/unit/test_kyc_service.py::test_verify_kyc ERROR                                 [ 84%]
tests/unit/test_kyc_service.py::test_reject_invalid_kyc ERROR                         [ 85%]
tests/unit/test_kyc_service.py::test_reject_invalid_kyc ERROR                         [ 85%]
tests/unit/test_logging.py::test_logger_initialization FAILED                         [ 86%]
tests/unit/test_logging.py::test_setup_logging FAILED                                 [ 88%]
tests/unit/test_noble_system.py::test_noble_rank_creation ERROR                       [ 89%]
tests/unit/test_noble_system.py::test_noble_relation_verification ERROR               [ 90%]
tests/unit/test_transformation.py::TestGoldTransformation::test_complete_transformation_flow ERROR [ 92%]
tests/unit/test_transformation.py::TestGoldTransformation::test_complete_transformation_flow ERROR [ 92%]
tests/unit/test_transformation.py::TestGoldTransformation::test_transformation_validation FAILED [ 93%]
tests/unit/test_transformation.py::TestGoldTransformation::test_transformation_with_fees ERROR [ 94%]
tests/unit/test_transformation.py::TestGoldTransformation::test_transformation_with_fees ERROR [ 94%]
tests/unit/test_two_factor_service.py::test_enable_2fa ERROR                          [ 96%]
tests/unit/test_two_factor_service.py::test_enable_2fa ERROR                          [ 96%]
tests/unit/test_two_factor_service.py::test_verify_valid_2fa_token PASSED             [ 97%]
tests/unit/test_two_factor_service.py::test_verify_invalid_2fa_token PASSED           [ 98%]
tests/unit/test_two_factor_service.py::test_2fa_qr_code_generation ERROR              [100%]
tests/unit/test_two_factor_service.py::test_2fa_qr_code_generation ERROR              [100%]

========================================== ERRORS ===========================================
______________________ ERROR at setup of test_transformation_endpoint _______________________

    @pytest.fixture
    def client():
>       app = create_app()
E       NameError: name 'create_app' is not defined

tests/functional/test_api.py:9: NameError
__________________________ ERROR at setup of test_account_balance ___________________________

    @pytest.fixture
    def client():
>       app = create_app()
E       NameError: name 'create_app' is not defined

tests/functional/test_api.py:9: NameError
_______________________ ERROR at setup of test_invalid_transformation _______________________

    @pytest.fixture
    def client():
>       app = create_app()
E       NameError: name 'create_app' is not defined

tests/functional/test_api.py:9: NameError
_________________________ ERROR at setup of test_complete_auth_flow _________________________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4245: in _do_configure_registries
    mapper._post_configure_properties()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2405: in _post_configure_properties
    prop.init()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/interfaces.py:584: in init
    self.do_init()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/relationships.py:1642: in do_init
    self._setup_entity()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/relationships.py:1854: in _setup_entity
    self._clsregistry_resolve_name(argument)(),
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/clsregistry.py:515: in _resolve_name
    rval = d[token]
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/util/_collections.py:344: in __missing__
    self[key] = val = self.creator(key)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/clsregistry.py:462: in _access_cls
    return _determine_container(key, decl_class_registry[key])
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/clsregistry.py:408: in _determine_container
    value = value.attempt_get([], key)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.clsregistry._MultipleClassMarker object at 0x7f32017de100>, path = []
key = 'User'

    def attempt_get(self, path: List[str], key: str) -> Type[Any]:
        if len(self.contents) > 1:
>           raise exc.InvalidRequestError(
                'Multiple classes found for path "%s" '
                "in the registry of this declarative "
                "base. Please use a fully module-qualified path."
                % (".".join(path + [key]))
            )
E           sqlalchemy.exc.InvalidRequestError: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/clsregistry.py:219: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_______________________ ERROR at teardown of test_complete_auth_flow ________________________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200fe0b10>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200fe0940> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_______________________ ERROR at setup of test_auth_with_invalid_2fa ________________________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

registries = set(), cascade = True

    @util.preload_module("sqlalchemy.orm.decl_api")
    def _do_configure_registries(
        registries: Set[_RegistryType], cascade: bool
    ) -> None:
        registry = util.preloaded.orm_decl_api.registry
    
        orig = set(registries)
    
        for reg in registry._recurse_with_dependencies(registries):
            has_skip = False
    
            for mapper in reg._mappers_to_configure():
                run_configure = None
    
                for fn in mapper.dispatch.before_mapper_configured:
                    run_configure = fn(mapper, mapper.class_)
                    if run_configure is EXT_SKIP:
                        has_skip = True
                        break
                if run_configure is EXT_SKIP:
                    continue
    
                if getattr(mapper, "_configure_failed", False):
                    e = sa_exc.InvalidRequestError(
                        "One or more mappers failed to initialize - "
                        "can't proceed with initialization of other "
                        "mappers. Triggering mapper: '%s'. "
                        "Original exception was: %s"
                        % (mapper, mapper._configure_failed)
                    )
                    e._configure_failed = mapper._configure_failed  # type: ignore
>                   raise e
E                   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Transaction(transactions)]'. Original exception was: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4241: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
______________________ ERROR at teardown of test_auth_with_invalid_2fa ______________________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f320074c090>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f320074c300> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_____________________ ERROR at setup of test_kyc_submission_validation ______________________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

registries = set(), cascade = True

    @util.preload_module("sqlalchemy.orm.decl_api")
    def _do_configure_registries(
        registries: Set[_RegistryType], cascade: bool
    ) -> None:
        registry = util.preloaded.orm_decl_api.registry
    
        orig = set(registries)
    
        for reg in registry._recurse_with_dependencies(registries):
            has_skip = False
    
            for mapper in reg._mappers_to_configure():
                run_configure = None
    
                for fn in mapper.dispatch.before_mapper_configured:
                    run_configure = fn(mapper, mapper.class_)
                    if run_configure is EXT_SKIP:
                        has_skip = True
                        break
                if run_configure is EXT_SKIP:
                    continue
    
                if getattr(mapper, "_configure_failed", False):
                    e = sa_exc.InvalidRequestError(
                        "One or more mappers failed to initialize - "
                        "can't proceed with initialization of other "
                        "mappers. Triggering mapper: '%s'. "
                        "Original exception was: %s"
                        % (mapper, mapper._configure_failed)
                    )
                    e._configure_failed = mapper._configure_failed  # type: ignore
>                   raise e
E                   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Transaction(transactions)]'. Original exception was: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4241: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
____________________ ERROR at teardown of test_kyc_submission_validation ____________________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200e51690>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200e51280> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_____________ ERROR at teardown of TestDistributionBackup.test_create_snapshot ______________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200b81d10>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200b815c0> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
----------------------------------- Captured stdout call ------------------------------------
Backup Error - Errore nella creazione dello snapshot: 'Session' object does not support the asynchronous context manager protocol
_____________ ERROR at teardown of TestDistributionBackup.test_restore_snapshot _____________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200d55510>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200d55100> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
________ ERROR at teardown of TestDistributionBackup.test_verify_snapshot_integrity _________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f320024fed0>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200284340> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
----------------------------------- Captured stdout call ------------------------------------
Backup Error - Errore nella creazione dello snapshot: 'Session' object does not support the asynchronous context manager protocol
____________ ERROR at teardown of TestDistributionBackup.test_snapshot_not_found ____________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200c9d690>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200c9d740> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
----------------------------------- Captured stdout call ------------------------------------
Backup Error - Errore nella verifica dello snapshot: 'Session' object does not support the asynchronous context manager protocol
_________ ERROR at teardown of TestDistributionValidator.test_validate_fixing_price _________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f32007c85d0>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f32007c9280> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
________ ERROR at teardown of TestDistributionValidator.test_validate_system_status _________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200bd7990>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200bd7580> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
----------------------------------- Captured stdout call ------------------------------------
Validation Error - Errore nella validazione dello stato sistema: 'Session' object does not support the asynchronous context manager protocol
_______ ERROR at teardown of TestDistributionValidator.test_check_database_integrity ________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200d08590>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200d0b640> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
----------------------------------- Captured stdout call ------------------------------------
Validation Error - Errore nel controllo integrit database: 'Session' object does not support the asynchronous context manager protocol
_____ ERROR at teardown of TestDistributionValidator.test_validate_distribution_result ______

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200b80390>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200b80240> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_ ERROR at setup of TestWeeklyDistribution.test_complete_distribution_flow_with_noble_ranks _

request = <SubRequest 'async_session' for <Coroutine test_complete_distribution_flow_with_noble_ranks>>
kwargs = {}, unittest = False, func = <function async_session at 0x7f32015fe3e0>
setup = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup at 0x7f3200e67560>
finalizer = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer at 0x7f3200fb79c0>

    @functools.wraps(fixture)
    def _asyncgen_fixture_wrapper(request: FixtureRequest, **kwargs: Any):
        unittest = False if pytest.version_tuple >= (8, 2) else fixturedef.unittest
        func = _perhaps_rebind_fixture_func(fixture, request.instance, unittest)
        event_loop = kwargs.pop(event_loop_fixture_id)
        gen_obj = func(
            **_add_kwargs(func, kwargs, event_loop_fixture_id, event_loop, request)
        )
    
        async def setup():
            res = await gen_obj.__anext__()
            return res
    
        def finalizer() -> None:
            """Yield again, to finalize."""
    
            async def async_finalizer() -> None:
                try:
                    await gen_obj.__anext__()
                except StopAsyncIteration:
                    pass
                else:
                    msg = "Async generator fixture didn't stop."
                    msg += "Yield only once."
                    raise ValueError(msg)
    
            event_loop.run_until_complete(async_finalizer())
    
>       result = event_loop.run_until_complete(setup())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:344: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:326: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:77: in async_session
    async with db.session() as session:
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:220: in __call__
    sess = self.registry()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/util/_collections.py:632: in __call__
    key = self.scopefunc()
.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/session.py:81: in _app_ctx_id
    return id(app_ctx._get_current_object())  # type: ignore[attr-defined]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _get_current_object() -> T:
        try:
            obj = local.get()
        except LookupError:
>           raise RuntimeError(unbound_message) from None
E           RuntimeError: Working outside of application context.
E           
E           This typically means that you attempted to use functionality that needed
E           the current application. To solve this, set up an application context
E           with app.app_context(). See the documentation for more information.

/nix/store/0krcky469imsipiwsdvbv8qs696d228n-python3.11-werkzeug-3.0.3/lib/python3.11/site-packages/werkzeug/local.py:519: RuntimeError
_____ ERROR at setup of TestWeeklyDistribution.test_multi_level_affiliate_distribution ______

request = <SubRequest 'async_session' for <Coroutine test_multi_level_affiliate_distribution>>
kwargs = {}, unittest = False, func = <function async_session at 0x7f32015fe3e0>
setup = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup at 0x7f3200e65080>
finalizer = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer at 0x7f3200e679c0>

    @functools.wraps(fixture)
    def _asyncgen_fixture_wrapper(request: FixtureRequest, **kwargs: Any):
        unittest = False if pytest.version_tuple >= (8, 2) else fixturedef.unittest
        func = _perhaps_rebind_fixture_func(fixture, request.instance, unittest)
        event_loop = kwargs.pop(event_loop_fixture_id)
        gen_obj = func(
            **_add_kwargs(func, kwargs, event_loop_fixture_id, event_loop, request)
        )
    
        async def setup():
            res = await gen_obj.__anext__()
            return res
    
        def finalizer() -> None:
            """Yield again, to finalize."""
    
            async def async_finalizer() -> None:
                try:
                    await gen_obj.__anext__()
                except StopAsyncIteration:
                    pass
                else:
                    msg = "Async generator fixture didn't stop."
                    msg += "Yield only once."
                    raise ValueError(msg)
    
            event_loop.run_until_complete(async_finalizer())
    
>       result = event_loop.run_until_complete(setup())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:344: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:326: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:77: in async_session
    async with db.session() as session:
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:220: in __call__
    sess = self.registry()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/util/_collections.py:632: in __call__
    key = self.scopefunc()
.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/session.py:81: in _app_ctx_id
    return id(app_ctx._get_current_object())  # type: ignore[attr-defined]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _get_current_object() -> T:
        try:
            obj = local.get()
        except LookupError:
>           raise RuntimeError(unbound_message) from None
E           RuntimeError: Working outside of application context.
E           
E           This typically means that you attempted to use functionality that needed
E           the current application. To solve this, set up an application context
E           with app.app_context(). See the documentation for more information.

/nix/store/0krcky469imsipiwsdvbv8qs696d228n-python3.11-werkzeug-3.0.3/lib/python3.11/site-packages/werkzeug/local.py:519: RuntimeError
_ ERROR at setup of TestWeeklyDistribution.test_distribution_validation[fixing_price0-balance0-Invalid fixing price] _

request = <SubRequest 'async_session' for <Coroutine test_distribution_validation[fixing_price0-balance0-Invalid fixing price]>>
kwargs = {}, unittest = False, func = <function async_session at 0x7f32015fe3e0>
setup = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup at 0x7f3200e67740>
finalizer = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer at 0x7f3200e66ca0>

    @functools.wraps(fixture)
    def _asyncgen_fixture_wrapper(request: FixtureRequest, **kwargs: Any):
        unittest = False if pytest.version_tuple >= (8, 2) else fixturedef.unittest
        func = _perhaps_rebind_fixture_func(fixture, request.instance, unittest)
        event_loop = kwargs.pop(event_loop_fixture_id)
        gen_obj = func(
            **_add_kwargs(func, kwargs, event_loop_fixture_id, event_loop, request)
        )
    
        async def setup():
            res = await gen_obj.__anext__()
            return res
    
        def finalizer() -> None:
            """Yield again, to finalize."""
    
            async def async_finalizer() -> None:
                try:
                    await gen_obj.__anext__()
                except StopAsyncIteration:
                    pass
                else:
                    msg = "Async generator fixture didn't stop."
                    msg += "Yield only once."
                    raise ValueError(msg)
    
            event_loop.run_until_complete(async_finalizer())
    
>       result = event_loop.run_until_complete(setup())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:344: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:326: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:77: in async_session
    async with db.session() as session:
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:220: in __call__
    sess = self.registry()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/util/_collections.py:632: in __call__
    key = self.scopefunc()
.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/session.py:81: in _app_ctx_id
    return id(app_ctx._get_current_object())  # type: ignore[attr-defined]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _get_current_object() -> T:
        try:
            obj = local.get()
        except LookupError:
>           raise RuntimeError(unbound_message) from None
E           RuntimeError: Working outside of application context.
E           
E           This typically means that you attempted to use functionality that needed
E           the current application. To solve this, set up an application context
E           with app.app_context(). See the documentation for more information.

/nix/store/0krcky469imsipiwsdvbv8qs696d228n-python3.11-werkzeug-3.0.3/lib/python3.11/site-packages/werkzeug/local.py:519: RuntimeError
_ ERROR at setup of TestWeeklyDistribution.test_distribution_validation[fixing_price1-balance1-Invalid fixing price] _

request = <SubRequest 'async_session' for <Coroutine test_distribution_validation[fixing_price1-balance1-Invalid fixing price]>>
kwargs = {}, unittest = False, func = <function async_session at 0x7f32015fe3e0>
setup = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup at 0x7f3200e66fc0>
finalizer = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer at 0x7f3200e64cc0>

    @functools.wraps(fixture)
    def _asyncgen_fixture_wrapper(request: FixtureRequest, **kwargs: Any):
        unittest = False if pytest.version_tuple >= (8, 2) else fixturedef.unittest
        func = _perhaps_rebind_fixture_func(fixture, request.instance, unittest)
        event_loop = kwargs.pop(event_loop_fixture_id)
        gen_obj = func(
            **_add_kwargs(func, kwargs, event_loop_fixture_id, event_loop, request)
        )
    
        async def setup():
            res = await gen_obj.__anext__()
            return res
    
        def finalizer() -> None:
            """Yield again, to finalize."""
    
            async def async_finalizer() -> None:
                try:
                    await gen_obj.__anext__()
                except StopAsyncIteration:
                    pass
                else:
                    msg = "Async generator fixture didn't stop."
                    msg += "Yield only once."
                    raise ValueError(msg)
    
            event_loop.run_until_complete(async_finalizer())
    
>       result = event_loop.run_until_complete(setup())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:344: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:326: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:77: in async_session
    async with db.session() as session:
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:220: in __call__
    sess = self.registry()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/util/_collections.py:632: in __call__
    key = self.scopefunc()
.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/session.py:81: in _app_ctx_id
    return id(app_ctx._get_current_object())  # type: ignore[attr-defined]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _get_current_object() -> T:
        try:
            obj = local.get()
        except LookupError:
>           raise RuntimeError(unbound_message) from None
E           RuntimeError: Working outside of application context.
E           
E           This typically means that you attempted to use functionality that needed
E           the current application. To solve this, set up an application context
E           with app.app_context(). See the documentation for more information.

/nix/store/0krcky469imsipiwsdvbv8qs696d228n-python3.11-werkzeug-3.0.3/lib/python3.11/site-packages/werkzeug/local.py:519: RuntimeError
_ ERROR at setup of TestWeeklyDistribution.test_distribution_validation[fixing_price2-balance2-Invalid balance] _

request = <SubRequest 'async_session' for <Coroutine test_distribution_validation[fixing_price2-balance2-Invalid balance]>>
kwargs = {}, unittest = False, func = <function async_session at 0x7f32015fe3e0>
setup = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup at 0x7f3200e66160>
finalizer = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer at 0x7f3200e674c0>

    @functools.wraps(fixture)
    def _asyncgen_fixture_wrapper(request: FixtureRequest, **kwargs: Any):
        unittest = False if pytest.version_tuple >= (8, 2) else fixturedef.unittest
        func = _perhaps_rebind_fixture_func(fixture, request.instance, unittest)
        event_loop = kwargs.pop(event_loop_fixture_id)
        gen_obj = func(
            **_add_kwargs(func, kwargs, event_loop_fixture_id, event_loop, request)
        )
    
        async def setup():
            res = await gen_obj.__anext__()
            return res
    
        def finalizer() -> None:
            """Yield again, to finalize."""
    
            async def async_finalizer() -> None:
                try:
                    await gen_obj.__anext__()
                except StopAsyncIteration:
                    pass
                else:
                    msg = "Async generator fixture didn't stop."
                    msg += "Yield only once."
                    raise ValueError(msg)
    
            event_loop.run_until_complete(async_finalizer())
    
>       result = event_loop.run_until_complete(setup())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:344: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:326: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:77: in async_session
    async with db.session() as session:
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:220: in __call__
    sess = self.registry()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/util/_collections.py:632: in __call__
    key = self.scopefunc()
.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/session.py:81: in _app_ctx_id
    return id(app_ctx._get_current_object())  # type: ignore[attr-defined]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _get_current_object() -> T:
        try:
            obj = local.get()
        except LookupError:
>           raise RuntimeError(unbound_message) from None
E           RuntimeError: Working outside of application context.
E           
E           This typically means that you attempted to use functionality that needed
E           the current application. To solve this, set up an application context
E           with app.app_context(). See the documentation for more information.

/nix/store/0krcky469imsipiwsdvbv8qs696d228n-python3.11-werkzeug-3.0.3/lib/python3.11/site-packages/werkzeug/local.py:519: RuntimeError
___________ ERROR at setup of TestWeeklyDistribution.test_performance_under_load ____________

request = <SubRequest 'async_session' for <Coroutine test_performance_under_load>>
kwargs = {}, unittest = False, func = <function async_session at 0x7f32015fe3e0>
setup = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup at 0x7f3200e642c0>
finalizer = <function _wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer at 0x7f3200e677e0>

    @functools.wraps(fixture)
    def _asyncgen_fixture_wrapper(request: FixtureRequest, **kwargs: Any):
        unittest = False if pytest.version_tuple >= (8, 2) else fixturedef.unittest
        func = _perhaps_rebind_fixture_func(fixture, request.instance, unittest)
        event_loop = kwargs.pop(event_loop_fixture_id)
        gen_obj = func(
            **_add_kwargs(func, kwargs, event_loop_fixture_id, event_loop, request)
        )
    
        async def setup():
            res = await gen_obj.__anext__()
            return res
    
        def finalizer() -> None:
            """Yield again, to finalize."""
    
            async def async_finalizer() -> None:
                try:
                    await gen_obj.__anext__()
                except StopAsyncIteration:
                    pass
                else:
                    msg = "Async generator fixture didn't stop."
                    msg += "Yield only once."
                    raise ValueError(msg)
    
            event_loop.run_until_complete(async_finalizer())
    
>       result = event_loop.run_until_complete(setup())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:344: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:326: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:77: in async_session
    async with db.session() as session:
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:220: in __call__
    sess = self.registry()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/util/_collections.py:632: in __call__
    key = self.scopefunc()
.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/session.py:81: in _app_ctx_id
    return id(app_ctx._get_current_object())  # type: ignore[attr-defined]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _get_current_object() -> T:
        try:
            obj = local.get()
        except LookupError:
>           raise RuntimeError(unbound_message) from None
E           RuntimeError: Working outside of application context.
E           
E           This typically means that you attempted to use functionality that needed
E           the current application. To solve this, set up an application context
E           with app.app_context(). See the documentation for more information.

/nix/store/0krcky469imsipiwsdvbv8qs696d228n-python3.11-werkzeug-3.0.3/lib/python3.11/site-packages/werkzeug/local.py:519: RuntimeError
________________________ ERROR at setup of test_network_interruption ________________________
file /home/runner/workspace/tests/unit/test_blockchain_monitor.py, line 38
  @pytest.mark.asyncio
  async def test_network_interruption(web3_mock):
      """Test behavior during network interruption"""
      monitor = BlockchainMonitor(web3_mock)
      web3_mock.eth.get_block.side_effect = BlockNotFound
      response = await monitor.process_block(12345)
      assert response['status'] == 'error'
      assert 'block not found' in response['message'].lower()
E       fixture 'web3_mock' not found
>       available fixtures: _session_event_loop, app, async_session, auth_headers, auth_token, blockchain_monitor, blockchain_service, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, client, cov, deployer, distribution_service, doctest_namespace, event_loop, event_loop_policy, mock_w3, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, runner, session_mocker, test_db, test_user, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unit/test_blockchain_monitor.py::<event_loop>, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/workspace/tests/unit/test_blockchain_monitor.py:38
________________________ ERROR at setup of test_invalid_transaction _________________________
file /home/runner/workspace/tests/unit/test_blockchain_monitor.py, line 47
  @pytest.mark.asyncio
  async def test_invalid_transaction(web3_mock):
      """Test handling of invalid transaction"""
      monitor = BlockchainMonitor(web3_mock)
      web3_mock.eth.get_transaction.side_effect = TransactionNotFound
      response = await monitor.verify_transaction('0x1234')
      assert response['status'] == 'error'
      assert 'transaction not found' in response['message'].lower()
E       fixture 'web3_mock' not found
>       available fixtures: _session_event_loop, app, async_session, auth_headers, auth_token, blockchain_monitor, blockchain_service, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, client, cov, deployer, distribution_service, doctest_namespace, event_loop, event_loop_policy, mock_w3, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, runner, session_mocker, test_db, test_user, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unit/test_blockchain_monitor.py::<event_loop>, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/workspace/tests/unit/test_blockchain_monitor.py:47
____________________________ ERROR at setup of test_empty_block _____________________________
file /home/runner/workspace/tests/unit/test_blockchain_monitor.py, line 61
  @pytest.mark.asyncio
  async def test_empty_block(web3_mock):
      """Test handling of empty blocks"""
      monitor = BlockchainMonitor(web3_mock)
      web3_mock.eth.get_block.return_value = {'transactions': [], 'number': 12345}
      response = await monitor.process_block(12345)
      assert response['status'] == 'success'
      assert len(response.get('transactions', [])) == 0
E       fixture 'web3_mock' not found
>       available fixtures: _session_event_loop, app, async_session, auth_headers, auth_token, blockchain_monitor, blockchain_service, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, client, cov, deployer, distribution_service, doctest_namespace, event_loop, event_loop_policy, mock_w3, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, runner, session_mocker, test_db, test_user, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unit/test_blockchain_monitor.py::<event_loop>, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/workspace/tests/unit/test_blockchain_monitor.py:61
_______________________ ERROR at setup of test_malformed_transaction ________________________
file /home/runner/workspace/tests/unit/test_blockchain_monitor.py, line 70
  @pytest.mark.asyncio
  async def test_malformed_transaction(web3_mock):
      """Test handling of malformed transaction data"""
      monitor = BlockchainMonitor(web3_mock)
      web3_mock.eth.get_transaction.return_value = {'hash': '0x1234', 'value': None}
      response = await monitor.verify_transaction('0x1234')
      assert response['status'] == 'error'
      assert 'invalid transaction data' in response['message'].lower()
E       fixture 'web3_mock' not found
>       available fixtures: _session_event_loop, app, async_session, auth_headers, auth_token, blockchain_monitor, blockchain_service, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, client, cov, deployer, distribution_service, doctest_namespace, event_loop, event_loop_policy, mock_w3, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, runner, session_mocker, test_db, test_user, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unit/test_blockchain_monitor.py::<event_loop>, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/workspace/tests/unit/test_blockchain_monitor.py:70
__________________________ ERROR at setup of test_network_timeout ___________________________
file /home/runner/workspace/tests/unit/test_blockchain_monitor.py, line 91
  @pytest.mark.asyncio
  async def test_network_timeout(web3_mock):
      """Test handling of network timeouts"""
      monitor = BlockchainMonitor(web3_mock)
      web3_mock.eth.get_block.side_effect = TimeoutError("Request timed out")
      response = await monitor.process_block(12345)
      assert response['status'] == 'error'
      assert 'timeout' in response['message'].lower()
E       fixture 'web3_mock' not found
>       available fixtures: _session_event_loop, app, async_session, auth_headers, auth_token, blockchain_monitor, blockchain_service, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, client, cov, deployer, distribution_service, doctest_namespace, event_loop, event_loop_policy, mock_w3, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, runner, session_mocker, test_db, test_user, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unit/test_blockchain_monitor.py::<event_loop>, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/workspace/tests/unit/test_blockchain_monitor.py:91
______ ERROR at setup of TestBonusDistributionService.test_distribute_structure_bonus _______

self = <test_bonus_service.TestBonusDistributionService object at 0x7f32013fc210>
app = <Flask 'app'>

    @pytest.fixture
    async def setup_test_data(self, app):
>       async with app.app_context():
E       TypeError: 'AppContext' object does not support the asynchronous context manager protocol

tests/unit/test_bonus_service.py:16: TypeError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_____ ERROR at setup of TestBonusDistributionService.test_distribute_rewards_successful _____

self = <test_bonus_service.TestBonusDistributionService object at 0x7f32013fea10>
app = <Flask 'app'>

    @pytest.fixture
    async def setup_test_data(self, app):
>       async with app.app_context():
E       TypeError: 'AppContext' object does not support the asynchronous context manager protocol

tests/unit/test_bonus_service.py:16: TypeError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
____ ERROR at setup of TestBonusDistributionService.test_distribute_rewards_invalid_rank ____

self = <test_bonus_service.TestBonusDistributionService object at 0x7f32013fd390>
app = <Flask 'app'>

    @pytest.fixture
    async def setup_test_data(self, app):
>       async with app.app_context():
E       TypeError: 'AppContext' object does not support the asynchronous context manager protocol

tests/unit/test_bonus_service.py:16: TypeError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_ ERROR at setup of TestBonusDistributionService.test_distribute_rewards_insufficient_balance _

self = <test_bonus_service.TestBonusDistributionService object at 0x7f32013ffd90>
app = <Flask 'app'>

    @pytest.fixture
    async def setup_test_data(self, app):
>       async with app.app_context():
E       TypeError: 'AppContext' object does not support the asynchronous context manager protocol

tests/unit/test_bonus_service.py:16: TypeError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_____________________________ ERROR at setup of test_submit_kyc _____________________________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

registries = set(), cascade = True

    @util.preload_module("sqlalchemy.orm.decl_api")
    def _do_configure_registries(
        registries: Set[_RegistryType], cascade: bool
    ) -> None:
        registry = util.preloaded.orm_decl_api.registry
    
        orig = set(registries)
    
        for reg in registry._recurse_with_dependencies(registries):
            has_skip = False
    
            for mapper in reg._mappers_to_configure():
                run_configure = None
    
                for fn in mapper.dispatch.before_mapper_configured:
                    run_configure = fn(mapper, mapper.class_)
                    if run_configure is EXT_SKIP:
                        has_skip = True
                        break
                if run_configure is EXT_SKIP:
                    continue
    
                if getattr(mapper, "_configure_failed", False):
                    e = sa_exc.InvalidRequestError(
                        "One or more mappers failed to initialize - "
                        "can't proceed with initialization of other "
                        "mappers. Triggering mapper: '%s'. "
                        "Original exception was: %s"
                        % (mapper, mapper._configure_failed)
                    )
                    e._configure_failed = mapper._configure_failed  # type: ignore
>                   raise e
E                   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Transaction(transactions)]'. Original exception was: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4241: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
___________________________ ERROR at teardown of test_submit_kyc ____________________________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f32002482d0>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f32003f2e40> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_____________________________ ERROR at setup of test_verify_kyc _____________________________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

registries = set(), cascade = True

    @util.preload_module("sqlalchemy.orm.decl_api")
    def _do_configure_registries(
        registries: Set[_RegistryType], cascade: bool
    ) -> None:
        registry = util.preloaded.orm_decl_api.registry
    
        orig = set(registries)
    
        for reg in registry._recurse_with_dependencies(registries):
            has_skip = False
    
            for mapper in reg._mappers_to_configure():
                run_configure = None
    
                for fn in mapper.dispatch.before_mapper_configured:
                    run_configure = fn(mapper, mapper.class_)
                    if run_configure is EXT_SKIP:
                        has_skip = True
                        break
                if run_configure is EXT_SKIP:
                    continue
    
                if getattr(mapper, "_configure_failed", False):
                    e = sa_exc.InvalidRequestError(
                        "One or more mappers failed to initialize - "
                        "can't proceed with initialization of other "
                        "mappers. Triggering mapper: '%s'. "
                        "Original exception was: %s"
                        % (mapper, mapper._configure_failed)
                    )
                    e._configure_failed = mapper._configure_failed  # type: ignore
>                   raise e
E                   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Transaction(transactions)]'. Original exception was: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4241: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
___________________________ ERROR at teardown of test_verify_kyc ____________________________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f320026cdd0>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f320026c900> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_________________________ ERROR at setup of test_reject_invalid_kyc _________________________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

registries = set(), cascade = True

    @util.preload_module("sqlalchemy.orm.decl_api")
    def _do_configure_registries(
        registries: Set[_RegistryType], cascade: bool
    ) -> None:
        registry = util.preloaded.orm_decl_api.registry
    
        orig = set(registries)
    
        for reg in registry._recurse_with_dependencies(registries):
            has_skip = False
    
            for mapper in reg._mappers_to_configure():
                run_configure = None
    
                for fn in mapper.dispatch.before_mapper_configured:
                    run_configure = fn(mapper, mapper.class_)
                    if run_configure is EXT_SKIP:
                        has_skip = True
                        break
                if run_configure is EXT_SKIP:
                    continue
    
                if getattr(mapper, "_configure_failed", False):
                    e = sa_exc.InvalidRequestError(
                        "One or more mappers failed to initialize - "
                        "can't proceed with initialization of other "
                        "mappers. Triggering mapper: '%s'. "
                        "Original exception was: %s"
                        % (mapper, mapper._configure_failed)
                    )
                    e._configure_failed = mapper._configure_failed  # type: ignore
>                   raise e
E                   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Transaction(transactions)]'. Original exception was: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4241: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_______________________ ERROR at teardown of test_reject_invalid_kyc ________________________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f32004f4550>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f32004f7c00> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
________________________ ERROR at setup of test_noble_rank_creation _________________________
file /home/runner/workspace/tests/unit/test_noble_system.py, line 7
  def test_noble_rank_creation(app, mock_blockchain_service):
E       fixture 'mock_blockchain_service' not found
>       available fixtures: _session_event_loop, app, async_session, auth_headers, auth_token, blockchain_monitor, blockchain_service, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, client, cov, deployer, distribution_service, doctest_namespace, event_loop, event_loop_policy, mock_w3, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, runner, session_mocker, test_db, test_user, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unit/test_noble_system.py::<event_loop>, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/workspace/tests/unit/test_noble_system.py:7
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
____________________ ERROR at setup of test_noble_relation_verification _____________________
file /home/runner/workspace/tests/unit/test_noble_system.py, line 19
  def test_noble_relation_verification(app, mock_blockchain_service):
E       fixture 'mock_blockchain_service' not found
>       available fixtures: _session_event_loop, app, async_session, auth_headers, auth_token, blockchain_monitor, blockchain_service, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, client, cov, deployer, distribution_service, doctest_namespace, event_loop, event_loop_policy, mock_w3, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, runner, session_mocker, test_db, test_user, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unit/test_noble_system.py::<event_loop>, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/workspace/tests/unit/test_noble_system.py:19
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
________ ERROR at setup of TestGoldTransformation.test_complete_transformation_flow _________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

registries = set(), cascade = True

    @util.preload_module("sqlalchemy.orm.decl_api")
    def _do_configure_registries(
        registries: Set[_RegistryType], cascade: bool
    ) -> None:
        registry = util.preloaded.orm_decl_api.registry
    
        orig = set(registries)
    
        for reg in registry._recurse_with_dependencies(registries):
            has_skip = False
    
            for mapper in reg._mappers_to_configure():
                run_configure = None
    
                for fn in mapper.dispatch.before_mapper_configured:
                    run_configure = fn(mapper, mapper.class_)
                    if run_configure is EXT_SKIP:
                        has_skip = True
                        break
                if run_configure is EXT_SKIP:
                    continue
    
                if getattr(mapper, "_configure_failed", False):
                    e = sa_exc.InvalidRequestError(
                        "One or more mappers failed to initialize - "
                        "can't proceed with initialization of other "
                        "mappers. Triggering mapper: '%s'. "
                        "Original exception was: %s"
                        % (mapper, mapper._configure_failed)
                    )
                    e._configure_failed = mapper._configure_failed  # type: ignore
>                   raise e
E                   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Transaction(transactions)]'. Original exception was: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4241: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_______ ERROR at teardown of TestGoldTransformation.test_complete_transformation_flow _______

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f32002b78d0>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f32002b4200> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
__________ ERROR at setup of TestGoldTransformation.test_transformation_with_fees ___________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

registries = set(), cascade = True

    @util.preload_module("sqlalchemy.orm.decl_api")
    def _do_configure_registries(
        registries: Set[_RegistryType], cascade: bool
    ) -> None:
        registry = util.preloaded.orm_decl_api.registry
    
        orig = set(registries)
    
        for reg in registry._recurse_with_dependencies(registries):
            has_skip = False
    
            for mapper in reg._mappers_to_configure():
                run_configure = None
    
                for fn in mapper.dispatch.before_mapper_configured:
                    run_configure = fn(mapper, mapper.class_)
                    if run_configure is EXT_SKIP:
                        has_skip = True
                        break
                if run_configure is EXT_SKIP:
                    continue
    
                if getattr(mapper, "_configure_failed", False):
                    e = sa_exc.InvalidRequestError(
                        "One or more mappers failed to initialize - "
                        "can't proceed with initialization of other "
                        "mappers. Triggering mapper: '%s'. "
                        "Original exception was: %s"
                        % (mapper, mapper._configure_failed)
                    )
                    e._configure_failed = mapper._configure_failed  # type: ignore
>                   raise e
E                   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Transaction(transactions)]'. Original exception was: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4241: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_________ ERROR at teardown of TestGoldTransformation.test_transformation_with_fees _________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200e6ecd0>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200e6cf00> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_____________________________ ERROR at setup of test_enable_2fa _____________________________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

registries = set(), cascade = True

    @util.preload_module("sqlalchemy.orm.decl_api")
    def _do_configure_registries(
        registries: Set[_RegistryType], cascade: bool
    ) -> None:
        registry = util.preloaded.orm_decl_api.registry
    
        orig = set(registries)
    
        for reg in registry._recurse_with_dependencies(registries):
            has_skip = False
    
            for mapper in reg._mappers_to_configure():
                run_configure = None
    
                for fn in mapper.dispatch.before_mapper_configured:
                    run_configure = fn(mapper, mapper.class_)
                    if run_configure is EXT_SKIP:
                        has_skip = True
                        break
                if run_configure is EXT_SKIP:
                    continue
    
                if getattr(mapper, "_configure_failed", False):
                    e = sa_exc.InvalidRequestError(
                        "One or more mappers failed to initialize - "
                        "can't proceed with initialization of other "
                        "mappers. Triggering mapper: '%s'. "
                        "Original exception was: %s"
                        % (mapper, mapper._configure_failed)
                    )
                    e._configure_failed = mapper._configure_failed  # type: ignore
>                   raise e
E                   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Transaction(transactions)]'. Original exception was: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4241: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
___________________________ ERROR at teardown of test_enable_2fa ____________________________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200274f90>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f32002776c0> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_______________________ ERROR at setup of test_2fa_qr_code_generation _______________________

app = <Flask 'app'>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    @pytest.fixture
    def test_user(app, test_db):
        """Crea un utente di test con account money e gold"""
        from app.models.models import User
    
        with app.app_context():
>           user = User(username='test_user', email='test@example.com')

tests/conftest.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/state.py:559: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/event/attr.py:497: in __call__
    fn(*args, **kw)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4396: in _event_on_init
    instrumenting_mapper._check_configure()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:2388: in _check_configure
    _configure_registries({self.registry}, cascade=True)
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4204: in _configure_registries
    _do_configure_registries(registries, cascade)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

registries = set(), cascade = True

    @util.preload_module("sqlalchemy.orm.decl_api")
    def _do_configure_registries(
        registries: Set[_RegistryType], cascade: bool
    ) -> None:
        registry = util.preloaded.orm_decl_api.registry
    
        orig = set(registries)
    
        for reg in registry._recurse_with_dependencies(registries):
            has_skip = False
    
            for mapper in reg._mappers_to_configure():
                run_configure = None
    
                for fn in mapper.dispatch.before_mapper_configured:
                    run_configure = fn(mapper, mapper.class_)
                    if run_configure is EXT_SKIP:
                        has_skip = True
                        break
                if run_configure is EXT_SKIP:
                    continue
    
                if getattr(mapper, "_configure_failed", False):
                    e = sa_exc.InvalidRequestError(
                        "One or more mappers failed to initialize - "
                        "can't proceed with initialization of other "
                        "mappers. Triggering mapper: '%s'. "
                        "Original exception was: %s"
                        % (mapper, mapper._configure_failed)
                    )
                    e._configure_failed = mapper._configure_failed  # type: ignore
>                   raise e
E                   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Transaction(transactions)]'. Original exception was: Multiple classes found for path "User" in the registry of this declarative base. Please use a fully module-qualified path.

/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/mapper.py:4241: InvalidRequestError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
_____________________ ERROR at teardown of test_2fa_qr_code_generation ______________________

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/nix/store/clx0mcir7qw8zk36zbr4jra789g3knf6-python3-3.11.10/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
/nix/store/lr8157i3piybdlm5a9g7rmyz6hxlz1cb-python3.11-pytest-asyncio-0.23.6/lib/python3.11/site-packages/pytest_asyncio/plugin.py:334: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:50: in test_db
    with app.app_context():
/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:284: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <flask.ctx.AppContext object at 0x7f3200d32590>, exc = None

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the app context."""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
>           _cv_app.reset(self._cv_tokens.pop())
E           ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200d30bc0> was created in a different Context

/nix/store/wm053mx50rc2050yhg0fjfm4516wr59y-python3.11-flask-3.0.3/lib/python3.11/site-packages/flask/ctx.py:265: ValueError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
========================================= FAILURES ==========================================
______________________________ test_concurrent_transformations ______________________________

    @pytest.mark.asyncio
    async def test_concurrent_transformations():
        service = TransformationService()
        tasks = []
        for i in range(5):
            task = asyncio.create_task(
                service.process_transformation(
                    user_id=i,
                    euro_amount=Decimal('100.00'),
                    fixing_price=Decimal('50.00')
                )
            )
            tasks.append(task)
    
>       results = await asyncio.gather(*tasks)

tests/performance/test_load.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/services/transformation_service.py:196: in process_transformation
    await db.session.rollback()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:1796: in rollback
    return self._proxied.rollback()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:197: in _proxied
    return self.registry()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/util/_collections.py:632: in __call__
    key = self.scopefunc()
.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/session.py:81: in _app_ctx_id
    return id(app_ctx._get_current_object())  # type: ignore[attr-defined]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _get_current_object() -> T:
        try:
            obj = local.get()
        except LookupError:
>           raise RuntimeError(unbound_message) from None
E           RuntimeError: Working outside of application context.
E           
E           This typically means that you attempted to use functionality that needed
E           the current application. To solve this, set up an application context
E           with app.app_context(). See the documentation for more information.

/nix/store/0krcky469imsipiwsdvbv8qs696d228n-python3.11-werkzeug-3.0.3/lib/python3.11/site-packages/werkzeug/local.py:519: RuntimeError
------------------------------------- Captured log call -------------------------------------
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 0 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 0
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 1 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 1
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 2 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 2
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 3 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 3
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 4 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 4
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
_____________________________ test_blockchain_batch_performance _____________________________

self = <app.services.blockchain_service.BlockchainService object at 0x7f3200ea8f90>
batch_data = [{'amount': Decimal('100.0'), 'timestamp': 1645564800, 'user_id': 0}, {'amount': Decimal('100.0'), 'timestamp': 164556....0'), 'timestamp': 1645564800, 'user_id': 4}, {'amount': Decimal('100.0'), 'timestamp': 1645564800, 'user_id': 5}, ...]

    async def process_batch_transformation(self, batch_data: List[Dict]) -> Any:
        """Process a batch of transformations on blockchain with security validation"""
        try:
            if not self.w3 or not self.contract or not self.account: #Check account as well
                raise ValueError("Blockchain connection or account not initialized")
    
            # Validate transaction data
            for tx in batch_data:
                if not self._validate_transaction_data(tx):
                    raise ValueError(f"Invalid transaction data: {tx}")
    
            # Validate gas price is within limits
>           gas_price = await self.w3.eth.gas_price
E           TypeError: object int can't be used in 'await' expression

app/services/blockchain_service.py:232: TypeError

During handling of the above exception, another exception occurred:

blockchain_service = <app.services.blockchain_service.BlockchainService object at 0x7f3200ea8f90>

    @pytest.mark.asyncio
    async def test_blockchain_batch_performance(blockchain_service):
        batch_size = 10
        batch_data = [
            {"user_id": i, "amount": Decimal('100.0'), "timestamp": 1645564800}
            for i in range(batch_size)
        ]
    
>       result = await blockchain_service.process_batch_transformation(batch_data)

tests/performance/test_load.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.services.blockchain_service.BlockchainService object at 0x7f3200ea8f90>
batch_data = [{'amount': Decimal('100.0'), 'timestamp': 1645564800, 'user_id': 0}, {'amount': Decimal('100.0'), 'timestamp': 164556....0'), 'timestamp': 1645564800, 'user_id': 4}, {'amount': Decimal('100.0'), 'timestamp': 1645564800, 'user_id': 5}, ...]

    async def process_batch_transformation(self, batch_data: List[Dict]) -> Any:
        """Process a batch of transformations on blockchain with security validation"""
        try:
            if not self.w3 or not self.contract or not self.account: #Check account as well
                raise ValueError("Blockchain connection or account not initialized")
    
            # Validate transaction data
            for tx in batch_data:
                if not self._validate_transaction_data(tx):
                    raise ValueError(f"Invalid transaction data: {tx}")
    
            # Validate gas price is within limits
            gas_price = await self.w3.eth.gas_price
            max_gas_price = self.w3.to_wei('100', 'gwei')
            if gas_price > max_gas_price:
                raise ValueError(f"Gas price too high: {gas_price}")
    
            # Validate nonce
            nonce = await self.w3.eth.get_transaction_count(self.account.address)
            if not self._validate_nonce(nonce):
                raise ValueError("Invalid nonce")
    
            # Process batch on blockchain with security checks
            tx = await self.contract.functions.processBatchTransformation(
                batch_data
            ).transact({
                'from': self.account.address,
                'nonce': nonce,
                'gas': 2000000,
                'gasPrice': min(gas_price, max_gas_price)
            })
    
            receipt = await self.w3.eth.wait_for_transaction_receipt(tx)
            if receipt.status != 1:
                raise ValueError("Transaction failed")
    
            self.monitor.monitor_transactions({'type': 'process_batch_transformation', 'status': 'success', 'tx_hash': receipt.transactionHash.hex()}) #Added monitoring call
            return receipt
    
        except Exception as e:
            logger.error(f"Blockchain transaction error: {str(e)}")
            logger.error(f"Blockchain batch processing error: {str(e)}")
>           self.monitor.send_alert(f"Blockchain batch processing error: {str(e)}") #Added alert call
E           AttributeError: 'NoneType' object has no attribute 'send_alert'

app/services/blockchain_service.py:262: AttributeError
----------------------------------- Captured stderr call ------------------------------------
2025-01-18 14:47:24,342 [ERROR] [GoldInvestment:260] Blockchain transaction error: object int can't be used in 'await' expression
2025-01-18 14:47:24,343 [ERROR] [GoldInvestment:261] Blockchain batch processing error: object int can't be used in 'await' expression
------------------------------------- Captured log call -------------------------------------
ERROR    GoldInvestment:blockchain_service.py:260 Blockchain transaction error: object int can't be used in 'await' expression
ERROR    GoldInvestment:blockchain_service.py:261 Blockchain batch processing error: object int can't be used in 'await' expression
_______________________________ test_system_under_heavy_load ________________________________

    @pytest.mark.asyncio
    async def test_system_under_heavy_load():
        service = TransformationService()
        large_batch = [
            (i, Decimal('100.00'), Decimal('50.00'))
            for i in range(20)
        ]
    
        tasks = [
            asyncio.create_task(
                service.process_transformation(
                    user_id=user_id,
                    euro_amount=amount,
                    fixing_price=price
                )
            )
            for user_id, amount, price in large_batch
        ]
    
>       results = await asyncio.gather(*tasks)

tests/performance/test_load.py:55: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/services/transformation_service.py:196: in process_transformation
    await db.session.rollback()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:1796: in rollback
    return self._proxied.rollback()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py:197: in _proxied
    return self.registry()
/nix/store/311mpmxk4759nkmbpgbj6ka44w9pgaqm-python3.11-sqlalchemy-2.0.30/lib/python3.11/site-packages/sqlalchemy/util/_collections.py:632: in __call__
    key = self.scopefunc()
.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/session.py:81: in _app_ctx_id
    return id(app_ctx._get_current_object())  # type: ignore[attr-defined]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _get_current_object() -> T:
        try:
            obj = local.get()
        except LookupError:
>           raise RuntimeError(unbound_message) from None
E           RuntimeError: Working outside of application context.
E           
E           This typically means that you attempted to use functionality that needed
E           the current application. To solve this, set up an application context
E           with app.app_context(). See the documentation for more information.

/nix/store/0krcky469imsipiwsdvbv8qs696d228n-python3.11-werkzeug-3.0.3/lib/python3.11/site-packages/werkzeug/local.py:519: RuntimeError
------------------------------------- Captured log call -------------------------------------
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 0 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 0
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 1 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 1
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 2 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 2
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 3 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 3
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 4 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 4
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 5 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 5
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 6 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 6
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 7 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 7
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 8 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 8
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 9 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 9
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 10 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 10
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 11 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 11
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 12 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 12
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 13 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 13
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 14 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 14
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 15 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 15
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 16 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 16
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 17 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 17
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 18 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 18
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
INFO     app.services.transformation_service:transformation_service.py:134 Inizio trasformazione - Utente: 19 - Importo: 100.00 - Fixing: 50.00
INFO     app.services.transformation_service:transformation_service.py:143 Controllo disponibilit fondi per utente 19
ERROR    app.services.transformation_service:transformation_service.py:33 Transfer verification error: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
ERROR    app.services.transformation_service:transformation_service.py:195 Transformation error: 'bool' object is not subscriptable
________________________________ test_performance_monitoring ________________________________

    def test_performance_monitoring():
        """Test performance monitoring capabilities"""
        monitor = PerformanceMonitor()
    
        for _ in range(100):
            monitor.record_metric('response_time', 0.1)
    
        metrics = monitor.get_metrics()
        assert 'response_time' in metrics
>       assert len(metrics['response_time']) == 100
E       AssertionError: assert 3 == 100
E        +  where 3 = len({'average': 0.09999999999999981, 'count': 100, 'latest': 0.1})

tests/performance/test_load.py:68: AssertionError
_________________________________ test_performance_monitor __________________________________

    def test_performance_monitor():
        """Test performance monitoring capabilities"""
        monitor = PerformanceMonitor()
        monitor.record_metric('test_category', 1.5)
    
        metrics = monitor.get_metrics()
        assert 'test_category' in metrics
>       assert len(metrics['test_category']) == 1
E       AssertionError: assert 3 == 1
E        +  where 3 = len({'average': 1.5, 'count': 1, 'latest': 1.5})

tests/performance/test_monitoring.py:26: AssertionError
___________________________ test_table_creation_and_optimization ____________________________

test_app = <Flask 'app'>

    def test_table_creation_and_optimization(test_app):
        """Test successful table creation and index optimization"""
        with test_app.app_context():
            db.create_all()
            db.session.commit()  # Ensure tables are created and committed
            # Get inspector
            inspector = inspect(db.engine)
            tables = inspector.get_table_names()
    
            # Verify core tables exist
            assert 'users' in tables, "Users table not found"
            assert 'noble_ranks' in tables, "Noble ranks table not found"
            assert 'transactions' in tables, "Transactions table not found"
    
            # Create indexes
            create_indexes()
    
            # Verify indexes
            indexes = inspector.get_indexes('users')
            index_names = [idx['name'] for idx in indexes]
            assert 'idx_users_email' in index_names, "Email index not created"
    
            # Verify foreign keys
            fks = inspector.get_foreign_keys('noble_ranks')
>           assert any(fk['referred_table'] == 'users' for fk in fks), "User foreign key not found"
E           AssertionError: User foreign key not found
E           assert False
E            +  where False = any(<generator object test_table_creation_and_optimization.<locals>.<genexpr> at 0x7f32013a71d0>)

tests/performance/test_optimization.py:43: AssertionError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
------------------------------------- Captured log call -------------------------------------
INFO     app.utils.optimization:optimization.py:81 Dropped existing index idx_transactions_user
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:81 Dropped existing index idx_transactions_status
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:81 Dropped existing index idx_noble_ranks_level
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:81 Dropped existing index idx_users_email
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
________________________ TestDistributionBackup.test_create_snapshot ________________________

self = <services.gold.test_distribution_backup.TestDistributionBackup object at 0x7f32014fa790>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    async def test_create_snapshot(self, test_db):
        backup = DistributionBackup()
>       snapshot_id = await backup.create_snapshot()

tests/services/gold/test_distribution_backup.py:14: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.services.gold.distribution_backup.DistributionBackup object at 0x7f3200b81210>

    async def create_snapshot(self) -> int:
        """Crea uno snapshot dello stato corrente dei saldi"""
        try:
            snapshot_data = {
                'timestamp': datetime.utcnow().isoformat(),
                'money_accounts': {},
                'gold_accounts': {}
            }
    
>           async with db.session() as session:
E           TypeError: 'Session' object does not support the asynchronous context manager protocol

app/services/gold/distribution_backup.py:22: TypeError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
----------------------------------- Captured stdout call ------------------------------------
Backup Error - Errore nella creazione dello snapshot: 'Session' object does not support the asynchronous context manager protocol
_______________________ TestDistributionBackup.test_restore_snapshot ________________________

self = <services.gold.test_distribution_backup.TestDistributionBackup object at 0x7f32014fb190>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    async def test_restore_snapshot(self, test_db):
        backup = DistributionBackup()
    
        # Create initial state
>       async with db.session() as session:
E       TypeError: 'Session' object does not support the asynchronous context manager protocol

tests/services/gold/test_distribution_backup.py:21: TypeError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
___________________ TestDistributionBackup.test_verify_snapshot_integrity ___________________

self = <services.gold.test_distribution_backup.TestDistributionBackup object at 0x7f32014fbb90>
test_db = <SQLAlchemy sqlite:////home/runner/workspace/instance/gold_investment.db>

    async def test_verify_snapshot_integrity(self, test_db):
        backup = DistributionBackup()
>       snapshot_id = await backup.create_snapshot()

tests/services/gold/test_distribution_backup.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.services.gold.distribution_backup.DistributionBackup object at 0x7f3200285e50>

    async def create_snapshot(self) -> int:
        """Crea uno snapshot dello stato corrente dei saldi"""
        try:
            snapshot_data = {
                'timestamp': datetime.utcnow().isoformat(),
                'money_accounts': {},
                'gold_accounts': {}
            }
    
>           async with db.session() as session:
E           TypeError: 'Session' object does not support the asynchronous context manager protocol

app/services/gold/distribution_backup.py:22: TypeError
------------------------------------ Captured log setup -------------------------------------
INFO     app:__init__.py:36 Gold Investment App startup
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8080
INFO     app.utils.load_balancer:load_balancer.py:24 Registered new server: 0.0.0.0:8081
INFO     app:__init__.py:74 Tables created successfully.
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_user on transactions
INFO     app.utils.optimization:optimization.py:86 Created index idx_transactions_status on transactions
WARNING  app.utils.optimization:optimization.py:66 Table transformations does not exist yet, skipping indexes
INFO     app.utils.optimization:optimization.py:86 Created index idx_noble_ranks_level on noble_ranks
INFO     app.utils.optimization:optimization.py:86 Created index idx_users_email on users
ERROR    app.utils.optimization:optimization.py:89 Error creating index idx_noble_relations_user on noble_relations: (sqlite3.OperationalError) no such column: noble_rank
[SQL: CREATE INDEX IF NOT EXISTS idx_noble_relations_user ON noble_relations(user_id, noble_rank)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA journal_mode=WAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA synchronous=NORMAL
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA cache_size=10000
INFO     app.utils.optimization:optimization.py:23 Successfully executed: PRAGMA temp_store=MEMORY
INFO     app.utils.optimization:optimization.py:27 Query optimization completed successfully
INFO     app.utils.optimization:optimization.py:99 Database optimization completed successfully
INFO     app:__init__.py:99 Application startup complete
----------------------------------- Captured stdout call ------------------------------------
Backup Error - Errore nella creazione dello snapshot: 'Session' object does not support the asynchronous context manager protocol
___________________________________ test_basic_monitoring ___________________________________

blockchain_monitor = <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f3200418e90>

    @pytest.mark.asyncio
    async def test_basic_monitoring(blockchain_monitor):
        """Test basic blockchain monitoring functionality"""
>       result = await blockchain_monitor.monitor_transactions()
E       TypeError: BlockchainMonitor.monitor_transactions() missing 1 required positional argument: 'transaction_data'

tests/unit/test_blockchain_monitor.py:22: TypeError
________________________________ test_transaction_validation ________________________________

blockchain_monitor = <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f32004c4650>

    def test_transaction_validation(blockchain_monitor):
        """Test transaction validation with various amounts"""
        test_cases = [
            (Decimal('0.001'), True),
            (Decimal('1000000.0'), True),
            (Decimal('0.0'), False),
            (Decimal('-1.0'), False),
        ]
    
        for amount, expected in test_cases:
>           assert blockchain_monitor.validate_transaction_amount(amount) == expected
E           AttributeError: 'BlockchainMonitor' object has no attribute 'validate_transaction_amount'

tests/unit/test_blockchain_monitor.py:36: AttributeError
_______________________________ test_concurrent_transactions ________________________________

blockchain_monitor = <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f3200418c10>

    def test_concurrent_transactions(blockchain_monitor):
        """Test handling multiple transactions simultaneously"""
        transactions = ['0x1234', '0x5678', '0x9abc']
>       assert blockchain_monitor.can_process_transactions(transactions) is True
E       AttributeError: 'BlockchainMonitor' object has no attribute 'can_process_transactions'

tests/unit/test_blockchain_monitor.py:59: AttributeError
__________________________________ test_extreme_gas_prices __________________________________

blockchain_monitor = <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f3200eaa4d0>

    def test_extreme_gas_prices(blockchain_monitor):
        """Test handling of extreme gas prices"""
        test_cases = [
            (0, True),
            (1_000_000_000_000_000, False),
            (10, True)
        ]
    
        for price, expected in test_cases:
            blockchain_monitor.w3.eth.gas_price = price
>           assert blockchain_monitor.is_gas_price_acceptable() == expected
E           assert True == False
E            +  where True = <bound method BlockchainMonitor.is_gas_price_acceptable of <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f3200eaa4d0>>()
E            +    where <bound method BlockchainMonitor.is_gas_price_acceptable of <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f3200eaa4d0>> = <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f3200eaa4d0>.is_gas_price_acceptable

tests/unit/test_blockchain_monitor.py:89: AssertionError
------------------------------------- Captured log call -------------------------------------
ERROR    app.utils.monitoring.blockchain_monitor:blockchain_monitor.py:28 Error checking gas price: 'BlockchainMonitor' object has no attribute 'alerts'
ERROR    app.utils.monitoring.blockchain_monitor:blockchain_monitor.py:28 Error checking gas price: 'BlockchainMonitor' object has no attribute 'alerts'
_________________________________ test_monitor_transaction __________________________________

blockchain_monitor = <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f3200344890>

    def test_monitor_transaction(blockchain_monitor):
        tx_data = {
            'type': 'gold_transformation',
            'status': 'success',
            'tx_hash': '0x123'
        }
        result = blockchain_monitor.monitor_transactions(tx_data)
>       assert result['status'] == 'monitored'
E       TypeError: 'coroutine' object is not subscriptable

tests/unit/test_blockchain_monitor.py:107: TypeError
_____________________________________ test_alert_system _____________________________________

blockchain_monitor = <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f32004187d0>

    def test_alert_system(blockchain_monitor):
>       result = blockchain_monitor.send_alert("Test alert")
E       AttributeError: 'BlockchainMonitor' object has no attribute 'send_alert'

tests/unit/test_blockchain_monitor.py:110: AttributeError
___________________________________ test_block_monitoring ___________________________________

blockchain_monitor = <app.utils.monitoring.blockchain_monitor.BlockchainMonitor object at 0x7f3200cbbe90>
mock_w3 = <Mock spec='Web3' id='139852738770192'>

    def test_block_monitoring(blockchain_monitor, mock_w3):
        mock_w3.eth.get_block_number.return_value = 1001
>       assert blockchain_monitor.check_new_blocks()
E       AttributeError: 'BlockchainMonitor' object has no attribute 'check_new_blocks'

tests/unit/test_blockchain_monitor.py:115: AttributeError
________________________________ test_logger_initialization _________________________________

    def test_logger_initialization():
        logger = get_logger("test")
>       assert logger.name == APP_NAME
E       AssertionError: assert 'GoldInvestment.test' == 'GoldInvestment'
E         
E         - GoldInvestment
E         + GoldInvestment.test
E         ?               +++++

tests/unit/test_logging.py:7: AssertionError
____________________________________ test_setup_logging _____________________________________

    def test_setup_logging():
        setup_logging()
>       logger = get_logger()
E       TypeError: get_logger() missing 1 required positional argument: 'name'

tests/unit/test_logging.py:11: TypeError
___________________ TestGoldTransformation.test_transformation_validation ___________________

self = <test_transformation.TestGoldTransformation object at 0x7f32013e0d50>
distribution_service = <app.services.gold.weekly_distribution.WeeklyGoldDistribution object at 0x7f32004b3490>
mock_fixing_price = Decimal('1800.00')

    @pytest.mark.asyncio
    async def test_transformation_validation(self, distribution_service, mock_fixing_price):
        """Test validation of transformation parameters"""
>       with pytest.raises(ValueError):
E       Failed: DID NOT RAISE <class 'ValueError'>

tests/unit/test_transformation.py:53: Failed
----------------------------------- Captured stdout call ------------------------------------
Errore nel logging: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
Errore nel logging: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
Backup Error - Errore nel ripristino dello snapshot: Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.
================================== short test summary info ==================================
SKIPPED [1] tests/integration/test_blockchain.py:32: Blockchain connection not available: 'NoneType' object has no attribute 'send_alert'
SKIPPED [1] tests/integration/test_blockchain.py:43: Blockchain connection not available: assert 'error' == 'verified'
  
  - verified
  + error
SKIPPED [1] tests/integration/test_blockchain_transactions.py:14: Blockchain connection not available
SKIPPED [1] tests/integration/test_blockchain_transactions.py:26: Blockchain connection not available
SKIPPED [1] tests/unit/test_blockchain_service.py:31: Blockchain connection not available: 'NoneType' object has no attribute 'send_alert'
ERROR tests/functional/test_api.py::test_transformation_endpoint - NameError: name 'create_app' is not defined
ERROR tests/functional/test_api.py::test_account_balance - NameError: name 'create_app' is not defined
ERROR tests/functional/test_api.py::test_invalid_transformation - NameError: name 'create_app' is not defined
ERROR tests/integration/test_auth_flow.py::test_complete_auth_flow - sqlalchemy.exc.InvalidRequestError: Multiple classes found for path "User" in the regist...
ERROR tests/integration/test_auth_flow.py::test_complete_auth_flow - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200fe...
ERROR tests/integration/test_auth_flow.py::test_auth_with_invalid_2fa - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't pro...
ERROR tests/integration/test_auth_flow.py::test_auth_with_invalid_2fa - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f320074...
ERROR tests/integration/test_auth_flow.py::test_kyc_submission_validation - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't pro...
ERROR tests/integration/test_auth_flow.py::test_kyc_submission_validation - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200e5...
ERROR tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_create_snapshot - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200b8...
ERROR tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_restore_snapshot - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200d5...
ERROR tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_verify_snapshot_integrity - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f320028...
ERROR tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_snapshot_not_found - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200c9...
ERROR tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_validate_fixing_price - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f32007c...
ERROR tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_validate_system_status - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200bd...
ERROR tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_check_database_integrity - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200d0...
ERROR tests/services/gold/test_distribution_validator.py::TestDistributionValidator::test_validate_distribution_result - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200b8...
ERROR tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_complete_distribution_flow_with_noble_ranks - RuntimeError: Working outside of application context.
ERROR tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_multi_level_affiliate_distribution - RuntimeError: Working outside of application context.
ERROR tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_distribution_validation[fixing_price0-balance0-Invalid fixing price] - RuntimeError: Working outside of application context.
ERROR tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_distribution_validation[fixing_price1-balance1-Invalid fixing price] - RuntimeError: Working outside of application context.
ERROR tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_distribution_validation[fixing_price2-balance2-Invalid balance] - RuntimeError: Working outside of application context.
ERROR tests/services/test_weekly_distribution.py::TestWeeklyDistribution::test_performance_under_load - RuntimeError: Working outside of application context.
ERROR tests/unit/test_blockchain_monitor.py::test_network_interruption
ERROR tests/unit/test_blockchain_monitor.py::test_invalid_transaction
ERROR tests/unit/test_blockchain_monitor.py::test_empty_block
ERROR tests/unit/test_blockchain_monitor.py::test_malformed_transaction
ERROR tests/unit/test_blockchain_monitor.py::test_network_timeout
ERROR tests/unit/test_bonus_service.py::TestBonusDistributionService::test_distribute_structure_bonus - TypeError: 'AppContext' object does not support the asynchronous context manager protocol
ERROR tests/unit/test_bonus_service.py::TestBonusDistributionService::test_distribute_rewards_successful - TypeError: 'AppContext' object does not support the asynchronous context manager protocol
ERROR tests/unit/test_bonus_service.py::TestBonusDistributionService::test_distribute_rewards_invalid_rank - TypeError: 'AppContext' object does not support the asynchronous context manager protocol
ERROR tests/unit/test_bonus_service.py::TestBonusDistributionService::test_distribute_rewards_insufficient_balance - TypeError: 'AppContext' object does not support the asynchronous context manager protocol
ERROR tests/unit/test_kyc_service.py::test_submit_kyc - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't pro...
ERROR tests/unit/test_kyc_service.py::test_submit_kyc - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f32003f...
ERROR tests/unit/test_kyc_service.py::test_verify_kyc - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't pro...
ERROR tests/unit/test_kyc_service.py::test_verify_kyc - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f320026...
ERROR tests/unit/test_kyc_service.py::test_reject_invalid_kyc - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't pro...
ERROR tests/unit/test_kyc_service.py::test_reject_invalid_kyc - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f32004f...
ERROR tests/unit/test_noble_system.py::test_noble_rank_creation
ERROR tests/unit/test_noble_system.py::test_noble_relation_verification
ERROR tests/unit/test_transformation.py::TestGoldTransformation::test_complete_transformation_flow - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't pro...
ERROR tests/unit/test_transformation.py::TestGoldTransformation::test_complete_transformation_flow - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f32002b...
ERROR tests/unit/test_transformation.py::TestGoldTransformation::test_transformation_with_fees - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't pro...
ERROR tests/unit/test_transformation.py::TestGoldTransformation::test_transformation_with_fees - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200e6...
ERROR tests/unit/test_two_factor_service.py::test_enable_2fa - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't pro...
ERROR tests/unit/test_two_factor_service.py::test_enable_2fa - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f320027...
ERROR tests/unit/test_two_factor_service.py::test_2fa_qr_code_generation - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't pro...
ERROR tests/unit/test_two_factor_service.py::test_2fa_qr_code_generation - ValueError: <Token var=<ContextVar name='flask.app_ctx' at 0x7f32037da750> at 0x7f3200d3...
FAILED tests/performance/test_load.py::test_concurrent_transformations - RuntimeError: Working outside of application context.
FAILED tests/performance/test_load.py::test_blockchain_batch_performance - AttributeError: 'NoneType' object has no attribute 'send_alert'
FAILED tests/performance/test_load.py::test_system_under_heavy_load - RuntimeError: Working outside of application context.
FAILED tests/performance/test_load.py::test_performance_monitoring - AssertionError: assert 3 == 100
FAILED tests/performance/test_monitoring.py::test_performance_monitor - AssertionError: assert 3 == 1
FAILED tests/performance/test_optimization.py::test_table_creation_and_optimization - AssertionError: User foreign key not found
FAILED tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_create_snapshot - TypeError: 'Session' object does not support the asynchronous context manager protocol
FAILED tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_restore_snapshot - TypeError: 'Session' object does not support the asynchronous context manager protocol
FAILED tests/services/gold/test_distribution_backup.py::TestDistributionBackup::test_verify_snapshot_integrity - TypeError: 'Session' object does not support the asynchronous context manager protocol
FAILED tests/unit/test_blockchain_monitor.py::test_basic_monitoring - TypeError: BlockchainMonitor.monitor_transactions() missing 1 required positional argume...
FAILED tests/unit/test_blockchain_monitor.py::test_transaction_validation - AttributeError: 'BlockchainMonitor' object has no attribute 'validate_transaction_amount'
FAILED tests/unit/test_blockchain_monitor.py::test_concurrent_transactions - AttributeError: 'BlockchainMonitor' object has no attribute 'can_process_transactions'
FAILED tests/unit/test_blockchain_monitor.py::test_extreme_gas_prices - assert True == False
FAILED tests/unit/test_blockchain_monitor.py::test_monitor_transaction - TypeError: 'coroutine' object is not subscriptable
FAILED tests/unit/test_blockchain_monitor.py::test_alert_system - AttributeError: 'BlockchainMonitor' object has no attribute 'send_alert'
FAILED tests/unit/test_blockchain_monitor.py::test_block_monitoring - AttributeError: 'BlockchainMonitor' object has no attribute 'check_new_blocks'
FAILED tests/unit/test_logging.py::test_logger_initialization - AssertionError: assert 'GoldInvestment.test' == 'GoldInvestment'
FAILED tests/unit/test_logging.py::test_setup_logging - TypeError: get_logger() missing 1 required positional argument: 'name'
FAILED tests/unit/test_transformation.py::TestGoldTransformation::test_transformation_validation - Failed: DID NOT RAISE <class 'ValueError'>
============= 19 failed, 21 passed, 5 skipped, 43 warnings, 48 errors in 12.80s =============
~/workspace$ 