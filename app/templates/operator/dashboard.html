
{% extends "admin/base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Dashboard Operatore</h2>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Nuova Transazione</h4>
                </div>
                <div class="card-body">
                    <form id="newTransactionForm">
                        <div class="mb-3">
                            <label class="form-label">Cliente</label>
                            <select class="form-select" name="user_id" required>
                                <!-- Popolato via JavaScript -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo Operazione</label>
                            <select class="form-select" name="type" required>
                                <option value="buy_gold">Acquisto Oro</option>
                                <option value="sell_gold">Vendita Oro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Importo (€)</label>
                            <input type="number" class="form-control" name="amount" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Invia per Approvazione</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Transazioni in Attesa</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Importo</th>
                                    <th>Stato</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTransactions">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadPendingTransactions();
    setInterval(loadPendingTransactions, 30000);
    
    document.getElementById('newTransactionForm').addEventListener('submit', submitTransaction);
});

function loadUsers() {
    fetch('/api/v1/users/list')
        .then(response => response.json())
        .then(data => {
            const select = document.querySelector('select[name="user_id"]');
            data.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.username} (${user.email})`;
                select.appendChild(option);
            });
        });
}

function loadPendingTransactions() {
    fetch('/api/v1/transactions/operator/pending')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('pendingTransactions');
            tbody.innerHTML = '';
            
            data.transactions.forEach(tx => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tx.id}</td>
                    <td>${tx.user_name}</td>
                    <td>${tx.type}</td>
                    <td>${tx.amount} €</td>
                    <td><span class="badge bg-warning">In Attesa</span></td>
                `;
                tbody.appendChild(row);
            });
        });
}

function submitTransaction(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    fetch('/api/v1/transactions/operator/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(Object.fromEntries(formData))
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Transazione inviata per approvazione');
            e.target.reset();
            loadPendingTransactions();
        } else {
            alert('Errore: ' + data.error);
        }
    });
}
</script>
{% endblock %}
